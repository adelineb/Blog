{# src/BlogJF/BlogBundle/Resouces/views/Blog/show.html.twig #}
{% extends 'BlogJFBlogBundle::layout.html.twig' %}

{% block title %}{{ billet.titre }}{% endblock %}

{% block body %}
    <article class="blog">
        <header>
            <h2>{{ billet.titre }}</h2>
        </header>
        <div>
            <p>{{ billet.roman |raw }}</p>
        </div>
    </article>

    <section class="commentaires" id="commentaires">
        <section class="previous-comments">
            <h3>Commentaires</h3>
            {% set id_prec = 0 %}
            {% set marge = 0 %}
            {% for commentaire in commentaires %}
                {% if id_prec == commentaire.parentid and id_prec != 0 %}
                    {%  set marge = marge + 50 %}
                {% elseif commentaire.parentid == 0 %}
                     {% set marge = 0 %}
                {% endif %}

                <div style="margin-left: {{ marge }}px;">
                    <article class="comment {{ cycle(['odd', 'even'], loop.index0) }}" id="comment-{{ commentaire.id }}">
                        <div id="comment">
                           <header>
                               <p><span class="highlight">{{ commentaire.auteur }}</span>, <time datetime="{{ commentaire.date|date('c') }}">{{ commentaire.date|localizeddate('none', 'none', null, null,'EEEE d MMMM Y') }}</time></p>
                           </header>
                           <p>{{ commentaire.commentaire |striptags|raw }}</p>

                            <input type="submit" class="btn btn-default reply" data-id="{{ commentaire.id }}" id="btn_repondre" value="Répondre" />
                       </div>
                    </article>
                </div>
                {% set id_prec = commentaire.id %}
            {% endfor %}
            <br/><br/>

        </section>
    </section>

    {#<input type="hidden" name="parent_id" value="0">#}
    <div class = "form-comment">
        <input name="parent_id" class = "parent_id" value="0">
        {{ form_start(form, {'action': path('blogjf_add', {'id' : billet.id, 'parentid' : 0}), 'method': 'POST', 'attr': {'class': 'form-horizontal', 'id': 'comment'}}) }}
        {# Les erreurs générales du formulaire. #}
        {{ form_errors(form) }}

        <h4>Poster un commentaire</h4>
        {{ form_widget(form.auteur) }}
        {{ form_widget(form.commentaire) }}
        {{ form_widget(form._token) }}

        <a href="{{ path('blogjf_accueil') }}"><input type="button" class="btn btn-danger" value="Annuler" /></a>
        <input type="submit" class="btn btn-default valid" value="Valider" />
        {{ form_end(form) }}
    </div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('bundles/fosjsrouting/js/router.js') }}"></script>
    <script src="{{ path('fos_js_routing_js', { callback: 'fos.Router.setData' }) }}"></script>

    <script>
        $(document).ready(function(){
            $('.reply').click(function(e){
                e.preventDefault();
                var $form = $('.form-comment');
                var $this = $(this);
                var parent_id = $this.attr('data-id');
                var comment = $('#comment-' + parent_id);
                $('.parent_id').val(parent_id);
                $form.find('h4').text('Répondre à ce commentaire');
                comment.after($form);
            })
        });

        $(document).ready(function(){
           $('.valid').click(function(e){
            e.preventDefault();
            var parent_id = $(this).attr('data-id');
            url = document.forms["comment"].action + "/" + $('.parent_id').val();
            document.location.href = url;
           })
        });
    </script>
{% endblock %}