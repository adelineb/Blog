{# src/BlogJF/BlogBundle/Resouces/views/Blog/show.html.twig #}
{% extends 'BlogJFBlogBundle::layout.html.twig' %}

{% block title %}{{ billet.titre }}{% endblock %}

{% block body %}
    <article class="blog">
        <header>
            <h2>{{ billet.titre }}</h2>
        </header>
        <div>
            <p>{{ billet.roman |raw }}</p>
        </div>
    </article>

    <section class="commentaires" id="commentaires">
        <section class="previous-comments">
            <h3>Commentaires</h3>
            {% set id_prec = 0 %}
            {% set marge = 0 %}
            {% set nbComm = 0 %}
            {% for commentaire in commentaires %}
                {{ commentaire.id }} <br>
                {% if commentaire.parentId == null %}
                    {{ form_widget(commentaire.id) }} / {{ form_widget(commentaire.parentId.id) }} / {{ form_widget(commentaire.commentaire) }}

                    {% if commentaire.children|length > 0 %}
                        enfants :

                        {% for commentaire in commentaire.children %}
                            {{ commentaire.id }} /
                        {% endfor %}
                           <br>
                    {% endif %}
                {% endif %}
                <br>
            {% endfor %}


            {% for commentaire in commentaires %}
                    {% if id_prec == commentaire.parentId.id and id_prec != 0 %}
                        {%  set marge = marge + 50 %}
                        {% set nbComm = nbComm + 1 %}
                    {% elseif commentaire.parentId.id == 0 %}
                         {% set marge = 0 %}
                         {% set nbComm = 0 %}
                    {% endif %}


                <div style="margin-left: {{ marge }}px;">
                    <article class="comment {{ cycle(['odd', 'even'], loop.index0) }}" id="comment-{{ commentaire.id }}">
                        {% if (commentaire.signaler == true) %}
                            <img src="{{ asset('images/signale.png') }}" class = "signale" alt="logo"/>
                        {% endif %}
                        <div id="comment">
                            <header>
                                <p><span class="highlight">{{ commentaire.id }} / {{ commentaire.auteur }}</span>, <time datetime="{{ commentaire.date|date('c') }}">{{ commentaire.date|localizeddate('none', 'none', null, null,'EEEE d MMMM Y') }}</time></p>
                            </header>
                            <p>{{ commentaire.commentaire |striptags|raw }}</p>
                            <div class="comment-button">
                                {% if commentaire.signaler == false %}
                                    <a href="{{ path('blogjf_signaler', {'idbillet' : billet.id, 'idcomment' : commentaire.id}) }}"><input type="button" class="btn btn-danger" value="Signaler" /></a>
                                {% else %}
                                    <a href="{{ path('blogjf_adminshow', {'id' : billet.id} )}}"><input type="button" disabled="false" class="btn btn-danger" value="signaler" /></a>
                                {% endif %}
                                {% if nbComm < 3 %}
                                    <input type="submit" class="btn btn-default reply" data-id="{{ commentaire.id }}" id="btn_repondre" value="Répondre" />
                                {% else %}
                                    <input type="submit" style="visibility:hidden" class="btn btn-default reply" data-id="{{ commentaire.id }}" id="btn_repondre" value="Répondre" />

                                {% endif %}
                            </div>
                       </div>
                    </article>
                </div>
                {% set id_prec = commentaire.id %}
            {% endfor %}

            <br/><br/>

        </section>
    </section>

    <div class = "form-comment">
        {{ form_start(form, {'action': path('blogjf_add', {'id' : billet.id, 'parentid' : null}), 'method': 'POST', 'attr': {'class': 'form-horizontal', 'id': 'formcomment'}}) }}
        {{ form_errors(form) }}

        <h4>Poster un commentaire</h4>
        {{ form_widget(form.auteur) }}
        {{ form_widget(form.commentaire, {'id': 'textareaid'}) }}
        {{ form_widget(form._token) }}

        <a href="{{ path('blogjf_accueil') }}"><input type="button" class="btn btn-danger" value="Annuler" /></a>
        <input type="submit" class="btn btn-default" value="Valider" />
        {{ form_end(form) }}
    </div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        $(document).ready(function(){
            $('.reply').click(function(e){
                e.preventDefault();
                var $divform = $('.form-comment');
                var $this = $(this);
                var parent_id = $this.attr('data-id');
                var comment = $('#comment-' + parent_id);
                $('.parent_id').val(parent_id);
                $divform.find('h4').text('Répondre à ce commentaire');
                var $form = $('#formcomment');
                commenturl = '/Blog/web/app_dev.php/' + {{ billet.id }} + '/comment/';
                $form.attr('action', commenturl + parent_id);
                comment.after($divform);
                var textareaId = 'textareaid';
                tinyMCE.get(textareaId).remove();
                tinyMCE.execCommand("mceAddEditor", false, textareaId);

            })
        });
    </script>
{% endblock %}
